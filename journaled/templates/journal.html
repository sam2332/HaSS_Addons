{% extends 'base.html' %}

{% block content %}
<div class="text-center">
    <h3 class="mb-3 mt-2">{{ saying }}, {{ user | title}}</h3>
    {% if inspirational_quote %}
        <!--inspirational_quote-->
        <blockquote class="blockquote">
            <p class="mb-0">{{ inspirational_quote }}</p>
        </blockquote>
    {% endif %}
    <form method="POST" enctype="multipart/form-data" class="mt-3">
        <!-- button bar/button group horizontal toolbar with dication buttons-->
        <textarea id='entry_input' name="content" placeholder="What's on your mind?">{{writing_prompt}}</textarea>
        <div class="form-group mt-2 col-3 mx-auto">
            <label for="attachment text-decoration-underline" id="attachment_label">Attachment?</label>
            <input type="file" class="form-control-file" id="attachment" name="attachments" multiple style="display:none;">
            <input type="hidden" name="mood" id="mood" value="">
        </div>
        <button type="submit" class="btn btn-primary mt-2">Submit</button>
    </form>

    <!-- mood banner (to show the custom one before a mood is detected)-->
     <div class="mt-3" id="mood_banner" style="display:none">
        <h5>How are you feeling today?</h5>
        <small class="text-muted">Click here to selecta mood.</small>
     </div>
    <!-- detected mood -->
    <div class="mt-3" id="auto_detect_container" style="display:none">
        <h5>Detected Mood</h5>
        <div class="form-control" id="detected_mood"></div>
        <small class="text-muted">Click on the mood to select a different one.</small>
    </div>
    <!--Other Mood Selector -->
    
    <div class="mt-3" id='other_mood_container' style="display:none">
        <h5>How are you feeling today?</h5>
        <select class="form-control" id="mood_selector">
            <option value="" disabled selected>Select your mood</option>
            <optgroup label="Positive Moods">
                <option class='mood_happy' value="happy">Happy</option>
                <option class='mood_excited' value="excited">Excited</option>
                <option class='mood_calm' value="calm">Calm</option>
                <option class='mood_hopeful' value="hopeful">Hopeful</option>
            </optgroup>
            <optgroup label="Neutral Moods">
                <option class='mood_neutral' value="neutral">Neutral</option>
                <option class='mood_indifferent' value="indifferent">Indifferent</option>
            </optgroup>
            <optgroup label="Negative Moods">
                <option class='mood_sad' value="sad">Sad</option>
                <option class='mood_angry' value="angry">Angry</option>
                <option class='mood_anxious' value="anxious">Anxious</option>
                <option class='mood_stressed' value="stressed">Stressed</option>
                <option class='mood_tired' value="tired">Tired</option>
                <option class='mood_confused' value="confused">Confused</option>
            </optgroup>
        </select>
    </div>

</div>

{% endblock %}
{% block extra_scripts %}
<script src="{{url_for('static', filename='js/extractMoods.js')}}"></script>
<script>
    window.custom_mood = false;
    document.getElementById("attachment_label").addEventListener("click", function() {
        document.getElementById("attachment").click();
    });
    
    document.getElementById("attachment").addEventListener("change", function() {
        document.getElementById("attachment").style.display = "block";
    });

    var ele = document.getElementById("mood_selector")
    ele.addEventListener("change", function() {
        document.getElementById("mood").value = ele.value;
        ele.classList = "form-control mood_" + ele.value;
    });


    var textarea = document.getElementById('entry_input')
    textarea.style.height = 'auto';  
    textarea.style.height = (textarea.scrollHeight+5) + 'px';  // Set 

    // auto detect mood
    var mood_banner = document.getElementById('mood_banner');
    var entry_input = document.getElementById('entry_input');
    var auto_detect_container = document.getElementById('auto_detect_container');
    var detected_mood = document.getElementById('detected_mood');
    var other_mood_container = document.getElementById('other_mood_container');

    entry_input.addEventListener('input', function() {
        if (window.custom_mood) {
            return;
        }
        var content = entry_input.value;
        if (content.length > 0) {
            var mood = extractMoods(content);
            if (mood == null) {
                return;
            }
            //IF MOOD IS VALUE IN THE SELECTOR
            var user_mood_lower = mood.toLowerCase();
            var mood_selector = document.getElementById('mood_selector');
            var options = mood_selector.options;
            for (var i = 0; i < options.length; i++) {
                if (options[i].value == user_mood_lower) {
                    mood_selector.value = user_mood_lower;
                    mood_selector.classList = "form-control mood_" + user_mood_lower;
                    break;
                }
            }
            mood_banner.style.display = 'none';
            auto_detect_container.style.display = 'block';
            detected_mood.innerHTML = mood;
            document.getElementById("mood").value = mood;

            detected_mood.classList = "mood_" + mood;
        } else {
            auto_detect_container.style.display = 'none';
        }
    });

    detected_mood.addEventListener('click', function() {
        auto_detect_container.style.display = 'none';
        mood_banner.style.display = 'none';
        other_mood_container.style.display = 'block';
        window.custom_mood = true;
    });
    </script>
{% endblock %}
